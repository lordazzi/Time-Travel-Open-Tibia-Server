<?php# AUTHOR: RICARDO AZZI ## CREATED: 15/11/12 #$GLOBAL["nocount"] = TRUE;require_once($_SERVER["DOCUMENT_ROOT"]."/plugins/config.php");$sql = new MySql("ttotserver");$checked = post("checked");$email = post("email");$recoverykey = post("recoverykey");$captcha = post("captcha");if (Captcha::Match($captcha) AND Captcha::getTries() <= 5) {	if ($checked == "viarecoverykey" AND preg_match("/^([A-Z0-9]{5}[-]){4}[A-Z0-9]{5}$/", $recoverykey)) {		$info = $sql->Query("SELECT email, name, id FROM  `accounts` WHERE  `key` =  '$recoverykey'");				if (count($info) == 1) {					} else {			Captcha::addTry();			callback(array(				"success" => FALSE,				"tries" => Captcha::getTries(),				"msg" => "Recovery Key incorreta"			));		}	} else if ($checked == "viaemail" AND Forms::isEmail($email)) {		$info = $sql->Query("			SELECT				a.email, a.name, a.id, a.`key`, b.txtusername, b.txtconfirm			FROM `accounts` a			INNER JOIN ttotsite.accounts b ON a.id = b.idaccount			WHERE a.email = '$email'		");				if (count($info) == 1) {			$cript = MD5(sha1(base64_encode($mail)));			$permission = base64_encode(time()."<>$email");			$sql->Query("UPDATE ttotsite.accounts SET txtchangepass='$permission' WHERE idaccount='".$info[0]["id"]."'");						sendMail(array(				"to" => $mail,				"assunto" => "Caro aventureiro! Bem vindo de volta ao Time Travel!",				"mensagem" => "					Olá <strong>".$info["txtusername"]."</strong>,<br />					<br />					Sejam bem vindo de volta ao nosso servidor!<br />					Este e-mail é resultado de uma solicitação de recuperação de senha:<br />					<strong>Clique:</strong> no link abaixo <strong>para reiniciar sua conta:</strong>					<a href='http://www.timetravel.net.br/account-reset-password.php?$permission'>http://www.timetravel.net.br/post/account-reset-password.php?$permission</a><br />					<em>Você tem 48 horas para reiniciar sua senha, depois deste tempo o link irá expirar.</em><br />					<br />					Você deve <strong>confirmar seu e-mail</strong> cadastrado clicando no seguinte link:<br />					<a href='http://www.timetravel.net.br/post/mail-confirm.php?$cript'>http://www.timetravel.net.br/post/mail-confirm.php?$cript</a><br />					<br />					Atenciosamente, equipe Time Travel<br />					<br />					<em>Se você não criou uma conta e há alguém usando seu endereço eletronico, responda este e-mail denunciando o cadastro.</em>"			));						callback(array(				"success" => FALSE,				"tries" => Captcha::getTries(),				"msg" => "Informações enviadas com sucesso para seu e-mail"			));		} else {			Captcha::addTry();			callback(array(				"success" => FALSE,				"tries" => Captcha::getTries(),				"msg" => "E-mail inserido inválido"			));		}	} else {		callback(array(			"success" => FALSE,			"tries" => Captcha::getTries(),			"msg" => "Nenhuma opção selecionada"		));	}} else {	if (Captcha::getTries() <= 5) {		callback(array(			"success" => FALSE,			"tries" => Captcha::getTries(),			"msg" => "Quantidade de tentativas excedida, tente novamente mais tarde"		));	} else {		callback(array(			"success" => FALSE,			"tries" => Captcha::getTries(),			"msg" => "Captcha incorreta"		));	}}?>